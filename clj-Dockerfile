# Start from a Clojure image
FROM clojure:temurin-21-tools-deps

# Set the working directory in the container
WORKDIR /usr/src/app

# Install Python, pip, and other utilities
RUN apt-get update && \
    apt-get install -y \
    python3 python3-pip python3-dev python3-venv libpython3-dev \
    build-essential git

# Create and activate a virtual environment
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install any needed packages specified in requirements.txt
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# Clone and install clojupyter
# RUN git clone https://github.com/clojupyter/clojupyter.git && \
#     cd clojupyter && \
#     make && \
#     clojure -M:install

# Install Clojure dependencies
COPY src/ .
COPY deps.edn . 
RUN clojure -P

# Copy the notebooks and data directories into the container at /usr/src/app
COPY notebooks/ .
COPY data/ .

# Expose the default Jupyter Notebook port
EXPOSE 8888

# Start the Jupyter Notebook server
CMD ["jupyter", "notebook", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root"]
